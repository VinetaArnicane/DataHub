# Adapted from https://hub.docker.com/r/apache/hive
version: "3"

services:
  testtrino:
    image: trinodb/trino:369
    container_name: "testtrino"
    ports:
      - 5300:8080
    volumes:
      - ./setup/etc:/etc/trino
    depends_on:
      - "trinodb_postgres"
      - "hive-metastore"

  trinodb_postgres:
    image: postgres:alpine
    container_name: "trinodb_postgres"
    environment:
      POSTGRES_PASSWORD: datahub
    volumes:
      - ./setup/setup.sql:/docker-entrypoint-initdb.d/postgres_setup.sql
    ports:
      - "5432:5432"

  hive-server:
    image: apache/hive:4.0.0-alpha-2
    platform: linux/amd64
    container_name: "testhiveserver2"
    user: root
    environment:
      IS_RESUME: true
      SERVICE_NAME: hiveserver2
      DB_DRIVER: derby
      SERVICE_OPTS: "-Dhive.metastore.uris=thrift://hive-metastore:9083"
    entrypoint:
      - "sh"
      - "-c"
      - "sleep 15 && /entrypoint.sh"
    ports:
      - "10000:10000"
      - "10002:10002"
    volumes:
      - ./setup/hive_setup.sql:/hive_setup.sql

  hive-metastore:
    image: apache/hive:4.0.0-alpha-2
    platform: linux/amd64
    container_name: "hive-metastore"
    user: root
    environment:
      SERVICE_NAME: metastore
      DB_DRIVER: derby
    ports:
      - "9083:9083"

# See https://github.com/TrivadisPF/platys-modern-data-platform/issues/231
# Underscore being added to hive metastore thrift URL in hive-server, resulting in error
networks:
  default:
    name: trino

# Adapted from https://github.com/big-data-europe/docker-hive.

version: "3"

services:
  presto:
    image: starburstdata/presto:350-e.15
    platform: linux/amd64
    container_name: "presto"
    ports:
      - 5300:8080
    volumes:
      - ./setup/etc:/etc/presto
    depends_on:
      - "hive-metastore"
  presto-cli:
    image: harisekhon/presto-cli-dev:latest
    platform: linux/amd64
    container_name: "presto-cli"
    command: "-f /dev/null"
    entrypoint: /usr/bin/tail
    depends_on:
      - "presto"

  hive-server:
    image: apache/hive:4.0.0-alpha-2
    platform: linux/amd64
    container_name: "hiveserver2"
    user: root
    environment:
      IS_RESUME: true
      SERVICE_NAME: hiveserver2
      DB_DRIVER: postgres
      SERVICE_OPTS: "-Dhive.metastore.uris=thrift://hive-metastore:9083"
    ports:
      - "10000:10000"
      - "10002:10002"
    entrypoint:
      - "sh"
      - "-c"
      - "sleep 15 && /entrypoint.sh"
    volumes:
      - ./setup/hive_setup.sql:/hive_setup.sql
    depends_on:
      - "hive-metastore"

  hive-metastore:
    image: apache/hive:4.0.0-alpha-2
    platform: linux/amd64
    container_name: "hive-metastore"
    user: root
    environment:
      SERVICE_NAME: metastore
      DB_DRIVER: postgres
      SERVICE_OPTS: |-
        -Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver
        -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://postgres:5432/metastore_db
        -Djavax.jdo.option.ConnectionUserName=postgres
        -Djavax.jdo.option.ConnectionPassword=datahub
    ports:
      - "9083:9083"
    depends_on:
      - "hive-metastore-postgresql"

  hive-metastore-postgresql:
    image: postgres:alpine
    container_name: "postgres"
    environment:
      POSTGRES_DB: metastore_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: datahub
    ports:
      - "5432:5432"

# See https://github.com/TrivadisPF/platys-modern-data-platform/issues/231
# Underscore being added to hive metastore thrift URL in hive-server, resulting in error
networks:
  default:
    name: presto-on-hive

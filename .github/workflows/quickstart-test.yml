name: Quickstart Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Run at midnight every day
  push:
    branches:
      - master
    paths:
      - "metadata-ingestion/src/datahub/cli/docker_cli.py"
      - "metadata-ingestion/src/datahub/cli/docker_check.py"
      - ".github/workflows/quickstart-test.yml"
  pull_request:
    branches:
      - master
    paths:
      - "metadata-ingestion/src/datahub/cli/docker_cli.py"
      - "metadata-ingestion/src/datahub/cli/docker_check.py"
      - ".github/workflows/quickstart-test.yml"

jobs:
  test-quickstart:
    name: Test Quickstart - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # os: [ubuntu-latest, macos-13, macos-15]
        os: [macos-13, macos-15]
        include:
          - os: macos-13
            label: macOS Intel
          - os: macos-15
            label: macOS Apple Silicon
          # - os: ubuntu-latest
          #   label: Linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # OS-specific setup steps
      - name: Linux-specific setup
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Add Linux-specific setup commands here
          # For example: installing system dependencies
          echo "Running Linux-specific setup"

      - name: macOS Intel setup
        if: matrix.os == 'macos-13' || matrix.os == 'macos-15'
        run: |
          # Install Homebrew if not already installed
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # Install Docker Desktop
          # brew install --cask docker
          curl -L -o Docker.dmg  https://desktop.docker.com/mac/main/amd64/191736/Docker.dmg

          whoami
          sudo hdiutil attach Docker.dmg
          sudo /Volumes/Docker/Docker.app/Contents/MacOS/install --accept-license 
          sudo hdiutil detach /Volumes/Docker

          #open -a /Applications/Docker.app

          # brew install docker-compose

          # Create Docker config directory and add plugin path
          mkdir -p ~/.docker
          echo '{"cliPluginsExtraDirs": ["/usr/local/lib/docker/cli-plugins"]}' > ~/.docker/config.json

          # Start Docker Desktop

          find /Applications/Docker.app | grep Docker
          #sudo '/Applications/Docker.app/Contents/MacOS/Docker Desktop' --unattended --install-privileged-components
          # sudo '/Applications/Docker.app/Contents/MacOS/Docker Desktop.app/Contents/MacOS/Docker Desktop' --unattended --install-privileged-components
          open -a /Applications/Docker.app --args --unattended --accept-license || true
          # open -a Docker 

          echo "We are waiting for Docker to be up and running. It can take over 2 minutes..."
          while ! /Applications/Docker.app/Contents/Resources/bin/docker info &>/dev/null; do sleep 1; done
          #brew services start docker

          # Wait for Docker to be ready
          echo "Waiting for Docker to be ready..."
          timeout=700
          while ! docker info &>/dev/null; do
            if [ $timeout -le 0 ]; then
              echo "Timeout waiting for Docker to start"
              exit 1
            fi
            sleep 1
            timeout=$((timeout-1))
          done
          echo "Docker is ready!"

      - name: macOS Apple Silicon setup
        if: false && matrix.os == 'macos-15'
        run: |
          # Install Homebrew if not already installed
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # Install Docker Desktop
          brew install --cask docker
          brew install docker-compose

          mkdir -p ~/.docker
          echo '{"cliPluginsExtraDirs": ["/usr/local/lib/docker/cli-plugins"]}' > ~/.docker/config.json

          # Start Docker Desktop
          # brew services start docker

          sudo '/Applications/Docker.app/Contents/MacOS/Docker Desktop' --unattended --install-privileged-components
          open -a /Applications/Docker.app --args --unattended --accept-license || true
          echo "We are waiting for Docker to be up and running. It can take over 2 minutes..."
          while ! /Applications/Docker.app/Contents/Resources/bin/docker info &>/dev/null; do sleep 1; done


          # Wait for Docker to be ready
          echo "Waiting for Docker to be ready..."
          timeout=300
          while ! docker info &>/dev/null; do
            if [ $timeout -le 0 ]; then
              echo "Timeout waiting for Docker to start"
              exit 1
            fi
            sleep 1
            timeout=$((timeout-1))
          done
          echo "Docker is ready!"

      - name: Install dependencies
        if: always()
        run: |
          python3 -m pip install --upgrade pip wheel setuptools
          python3 -m pip install --upgrade acryl-datahub

      - name: Run quickstart test
        if: always()
        run: |
          datahub docker quickstart
          # TODO: Add actual test steps here

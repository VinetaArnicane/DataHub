dist: trusty

sudo: required

language: java

jdk:
  - oraclejdk8

env:
  - DOCKER_COMPOSE_VERSION=1.14.0 WHEREHOWS_DIR=wherehows-web

services:
  - docker
  - elasticsearch

before_install:
  # elasticsearch
  - curl -O https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/2.3.3/elasticsearch-2.3.3.deb && sudo dpkg -i --force-confnew elasticsearch-2.3.3.deb && sudo service elasticsearch restart

  # extralibs
  - wget https://github.com/ericsun2/sandbox/raw/master/extralibs/extralibs.zip
  - mkdir -p wherehows-etl/extralibs; unzip extralibs.zip -d wherehows-etl/extralibs

  # docker-compose
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

  # Repo for newer Node.js versions
  - curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
  # https://yarnpkg.com/en/docs/install-ci#travis-tab
  # Repo for Yarn
  - sudo apt-key adv --fetch-keys http://dl.yarnpkg.com/debian/pubkey.gpg
  - echo "deb http://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
  - sudo apt-get update -qq
  - sudo apt-get install -y -qq yarn

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

script:
- ./gradlew check assemble
- ./gradlew jacocoFullReport coveralls
- (cd wherehows-docker && ./build.sh latest)
- (cd wherehows-docker && docker-compose config)
- (cd $WHEREHOWS_DIR && yarn install --non-interactive && node_modules/bower/bin/bower install && npm run-script coverage)

after_script:
  - rm -rf $WHEREHOWS_DIR/coverage
